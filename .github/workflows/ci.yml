# .github/workflows/go-ci.yml
name: Go CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      # "postgres" ã¨ã„ã†åå‰ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã‚’å®šç¾©
      postgres:
        # Docker Hubã®å…¬å¼PostgreSQLã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
        image: postgres:13-alpine
        # ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠï¼ˆPostgreSQLè‡ªä½“ï¼‰ã®åˆæœŸåŒ–ç”¨ç’°å¢ƒå¤‰æ•°
        env:
          POSTGRES_USER: 'postgres'
          POSTGRES_PASSWORD: 'password'
          POSTGRES_DB: 'fleamarket'
        # DBãŒèµ·å‹•ã—ã¦æ¥ç¶šå¯èƒ½ã«ãªã‚‹ã¾ã§å¾…ã¤ãŸã‚ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          # ã‚³ãƒ³ãƒ†ãƒŠã®5432ãƒãƒ¼ãƒˆã‚’ãƒ›ã‚¹ãƒˆï¼ˆå®Ÿè¡Œç’°å¢ƒï¼‰ã®5432ãƒãƒ¼ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°
          - 5432:5432

    env:
      ENV: 'test' # CIç’°å¢ƒãªã®ã§ "prod" ã§ã¯ãªã "test" ã«å¤‰æ›´
      DB_HOST: localhost # ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã¯ localhost ã§æ¥ç¶šã§ãã‚‹
      DB_PORT: 5432 # ä¸Šè¨˜ã® ports ã§ãƒãƒƒãƒ”ãƒ³ã‚°ã—ãŸãƒãƒ¼ãƒˆ
      DB_USER: 'postgres'
      DB_PASSWORD: 'password'
      DB_NAME: 'fleamarket'
      SECRET_KEY: '47ed8f16a737a02a43b5211703e6452288961a15b4bebe5683ac862176df515b'

    steps:
      # ------------- ã‚½ãƒ¼ã‚¹å–å¾— -------------
      - name: ğŸ›ï¸  Checkout code
        uses: actions/checkout@v4

      # ------------- Install cli tools -------------
      - name: ğŸ“¥  Install gotestsum
        run: |
          go install gotest.tools/gotestsum@latest

      - name: ğŸ“¥  Install golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: v1.57.2
          install-only: true

      # ------------- Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -------------
      - name: ğŸ”§  Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      # ------------- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ -------------
      - name: ğŸ—„ï¸  Cache go-build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: go-build-${{ runner.os }}-${{ hashFiles('**/*.go') }}
          restore-keys: |
            go-build-${{ runner.os }}-

      - name: ğŸ—„ï¸  Cache go mod
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: go-mod-${{ runner.os }}-${{ hashFiles('**/go.mod', '**/go.sum') }}
          restore-keys: |
            go-mod-${{ runner.os }}-

      # ------------- ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -------------
      - name: ğŸ“¦  Install dependencies
        run: go mod download

      # ------------- ãƒ†ã‚¹ãƒˆ -------------
      - name: âœ…  Run tests (make test)
        id: test
        run: make test 2>&1 | tee test.log
        continue-on-error: true

      # ------------- Lint -------------
      - name: ğŸ”  Run lint (make lint)
        id: lint
        run: make lint 2>&1 | tee lint.log
        continue-on-error: true

      # ------------- ãƒ­ã‚°æ•´ç†ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰-------------
      - name: ğŸ“„  Collect error logs
        id: logs
        if: steps.test.outcome == 'failure' || steps.lint.outcome == 'failure'
        run: |
          {
            echo "---- test.log (tail 50) ----"
            tail -n 50 test.log 2>/dev/null || true
            echo
            echo "---- lint.log (tail 50) ----"
            tail -n 50 lint.log 2>/dev/null || true
          } > slack_body.txt
          # GITHUB_OUTPUT ã¸æ¸¡ã™
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat slack_body.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ------------- Slack é€šçŸ¥ -------------
      - name: ğŸ“£  Notify Slack
        # always() ã«ã—ãªã„ã¨æˆåŠŸæ™‚ã«å®Ÿè¡Œã•ã‚Œãªã„
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_URL }}
        with:
          # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€
          payload-file-path: '.github/slack/payload.json'

      # ------------- æœ€çµ‚çš„ãªçµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -------------
      - name: âŒ  Fail job if any step failed
        if: steps.test.outcome == 'failure' || steps.lint.outcome == 'failure'
        run: exit 1
